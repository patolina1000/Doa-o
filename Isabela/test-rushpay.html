<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste RushPay - Campanha Ang√©lica</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .test-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .credentials {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Integra√ß√£o RushPay</h1>
        <p>Esta p√°gina permite testar a integra√ß√£o com a API RushPay para a campanha da Ang√©lica.</p>
        
        <div class="credentials">
            <h3>üìã Credenciais Configuradas</h3>
            <p><strong>Public Key:</strong> <span id="publicKey">Carregando...</span></p>
            <p><strong>Secret Key:</strong> <span id="secretKey">Carregando...</span></p>
            <p><strong>Ambiente:</strong> <span id="environment">Carregando...</span></p>
            <p><strong>URL Base:</strong> <span id="baseUrl">Carregando...</span></p>
        </div>

        <div class="test-section">
            <h3>üîå Teste de Conectividade</h3>
            <p>Verifica se a API RushPay est√° acess√≠vel.</p>
            <button onclick="testConnectivity()">Testar Conectividade</button>
            <div id="connectivityResult"></div>
        </div>

        <div class="test-section">
            <h3>üí≥ Teste de Cria√ß√£o de Transa√ß√£o PIX</h3>
            <p>Cria uma transa√ß√£o PIX de teste.</p>
            <label>Valor: R$ <input type="number" id="testAmount" value="25.00" step="0.01" min="25"></label><br><br>
            <label>Nome: <input type="text" id="customerName" value="Jo√£o Teste" style="width: 200px;"></label><br><br>
            <label>Email: <input type="email" id="customerEmail" value="joao@teste.com" style="width: 200px;"></label><br><br>
            <button onclick="createTestTransaction()">Criar Transa√ß√£o PIX</button>
            <div id="transactionResult"></div>
        </div>

        <div class="test-section">
            <h3>üîç Consulta de Status</h3>
            <p>Consulta o status de uma transa√ß√£o espec√≠fica.</p>
            <label>ID da Transa√ß√£o: <input type="text" id="transactionId" placeholder="txn_abc123" style="width: 300px;"></label><br><br>
            <button onclick="checkTransactionStatus()">Consultar Status</button>
            <div id="statusResult"></div>
        </div>

        <div class="test-section">
            <h3>üìä Teste de Listagem</h3>
            <p>Lista transa√ß√µes recentes.</p>
            <button onclick="listTransactions()">Listar Transa√ß√µes</button>
            <div id="listResult"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Teste de Doa√ß√£o Completa</h3>
            <p>Simula uma doa√ß√£o completa com add-ons.</p>
            <label>Valor Base: R$ <input type="number" id="donationAmount" value="50.00" step="0.01" min="25"></label><br><br>
            <label><input type="checkbox" id="addonTransport" value="10"> Aux√≠lio Transporte (+R$ 10,00)</label><br>
            <label><input type="checkbox" id="addonMeal" value="15"> Aux√≠lio Refei√ß√£o (+R$ 15,00)</label><br>
            <label><input type="checkbox" id="addonBasket" value="85"> Cesta B√°sica (+R$ 85,00)</label><br><br>
            <button onclick="testFullDonation()">Processar Doa√ß√£o</button>
            <div id="donationResult"></div>
        </div>

        <div class="test-section">
            <h3>üìù Log de Atividades</h3>
            <button onclick="clearLog()">Limpar Log</button>
            <div id="activityLog" class="test-result">Log ser√° exibido aqui...</div>
        </div>
    </div>

    <!-- Scripts da integra√ß√£o RushPay -->
    <script src="js/rushpay-config.js"></script>
    <script src="js/rushpay-integration.js"></script>

    <script>
        let campaignPayments = null;
        let activityLog = [];

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            try {
                campaignPayments = new AngelicaCampaignPayments();
                loadCredentials();
                log('‚úÖ Sistema RushPay inicializado com sucesso');
            } catch (error) {
                log('‚ùå Erro ao inicializar sistema RushPay: ' + error.message);
            }
        });

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            activityLog.push(`[${timestamp}] ${message}`);
            document.getElementById('activityLog').textContent = activityLog.join('\n');
        }

        function clearLog() {
            activityLog = [];
            document.getElementById('activityLog').textContent = 'Log limpo...';
        }

        function loadCredentials() {
            const config = getRushPayConfig();
            document.getElementById('publicKey').textContent = config.PUBLIC_KEY ? 
                config.PUBLIC_KEY.substring(0, 8) + '...' : 'N√£o configurada';
            document.getElementById('secretKey').textContent = config.SECRET_KEY ? 
                config.SECRET_KEY.substring(0, 8) + '...' : 'N√£o configurada';
            document.getElementById('environment').textContent = config.SANDBOX ? 'SANDBOX' : 'PRODU√á√ÉO';
            document.getElementById('baseUrl').textContent = config.baseUrl;
        }

        async function testConnectivity() {
            const button = event.target;
            const resultDiv = document.getElementById('connectivityResult');
            
            button.disabled = true;
            button.textContent = 'Testando...';
            resultDiv.innerHTML = '<div class="info">üîÑ Testando conectividade...</div>';
            
            try {
                log('üåê Iniciando teste de conectividade...');
                const result = await campaignPayments.rushPay.testConnectivity();
                
                if (result === true) {
                    resultDiv.innerHTML = '<div class="success">‚úÖ Conectividade OK! API RushPay acess√≠vel.</div>';
                    log('‚úÖ Teste de conectividade bem-sucedido');
                } else if (result === 'demo_mode') {
                    resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è API RushPay n√£o acess√≠vel - Modo demonstra√ß√£o ativado.<br>Os testes funcionar√£o com dados simulados.</div>';
                    log('‚ö†Ô∏è Modo demonstra√ß√£o ativado - API n√£o acess√≠vel');
                } else {
                    resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è API n√£o respondeu conforme esperado. Verifique as configura√ß√µes.</div>';
                    log('‚ö†Ô∏è Teste de conectividade com problemas');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro de conectividade: ${error.message}</div>`;
                log('‚ùå Erro no teste de conectividade: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Testar Conectividade';
            }
        }

        async function createTestTransaction() {
            const button = event.target;
            const resultDiv = document.getElementById('transactionResult');
            const amount = parseFloat(document.getElementById('testAmount').value);
            const customerName = document.getElementById('customerName').value;
            const customerEmail = document.getElementById('customerEmail').value;
            
            button.disabled = true;
            button.textContent = 'Criando...';
            resultDiv.innerHTML = '<div class="info">üîÑ Criando transa√ß√£o PIX...</div>';
            
            try {
                log(`üí≥ Criando transa√ß√£o PIX - Valor: R$ ${amount.toFixed(2)}`);
                
                const result = await campaignPayments.processDonation(amount, [], {
                    name: customerName,
                    email: customerEmail
                });
                
                if (result.success) {
                    const demoModeText = result.demoMode ? ' (MODO DEMONSTRA√á√ÉO)' : '';
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Transa√ß√£o criada com sucesso!${demoModeText}</div>
                        <div class="test-result">
ID: ${result.transactionId}
Status: ${result.status}
Valor: R$ ${result.amount.toFixed(2)}
PIX Code: ${result.pixCode ? result.pixCode.substring(0, 50) + '...' : 'N√£o dispon√≠vel'}
QR Code: ${result.qrCodeBase64 ? 'Dispon√≠vel' : 'N√£o dispon√≠vel'}
Expira em: ${result.expiresAt || 'N√£o informado'}
${result.demoMode ? '\n‚ö†Ô∏è ATEN√á√ÉO: Dados simulados para demonstra√ß√£o' : ''}
                        </div>
                    `;
                    
                    // Preencher campo de ID para consulta
                    document.getElementById('transactionId').value = result.transactionId;
                    
                    log(`‚úÖ Transa√ß√£o criada: ${result.transactionId}`);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erro ao criar transa√ß√£o: ${result.error}</div>`;
                    log(`‚ùå Erro ao criar transa√ß√£o: ${result.error}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro inesperado: ${error.message}</div>`;
                log(`‚ùå Erro inesperado ao criar transa√ß√£o: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Criar Transa√ß√£o PIX';
            }
        }

        async function checkTransactionStatus() {
            const button = event.target;
            const resultDiv = document.getElementById('statusResult');
            const transactionId = document.getElementById('transactionId').value;
            
            if (!transactionId) {
                resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Informe o ID da transa√ß√£o</div>';
                return;
            }
            
            button.disabled = true;
            button.textContent = 'Consultando...';
            resultDiv.innerHTML = '<div class="info">üîÑ Consultando status...</div>';
            
            try {
                log(`üîç Consultando status da transa√ß√£o: ${transactionId}`);
                
                const result = await campaignPayments.rushPay.getTransactionStatus(transactionId);
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Status consultado com sucesso!</div>
                        <div class="test-result">
ID: ${result.transactionId}
Status: ${result.status}
Valor: R$ ${result.amount.toFixed(2)}
Moeda: ${result.currency}
Criado em: ${result.createdAt}
Pago em: ${result.paidAt || 'N√£o pago'}
Cliente: ${result.customer?.name || 'N√£o informado'}
                        </div>
                    `;
                    log(`‚úÖ Status consultado: ${result.status}`);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erro ao consultar status: ${result.error}</div>`;
                    log(`‚ùå Erro ao consultar status: ${result.error}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro inesperado: ${error.message}</div>`;
                log(`‚ùå Erro inesperado ao consultar status: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Consultar Status';
            }
        }

        async function listTransactions() {
            const button = event.target;
            const resultDiv = document.getElementById('listResult');
            
            button.disabled = true;
            button.textContent = 'Listando...';
            resultDiv.innerHTML = '<div class="info">üîÑ Listando transa√ß√µes...</div>';
            
            try {
                log('üìä Listando transa√ß√µes recentes...');
                
                const result = await campaignPayments.rushPay.listTransactions({ limit: 10 });
                
                if (result.success) {
                    const transactions = result.transactions;
                    let html = `<div class="success">‚úÖ ${transactions.length} transa√ß√µes encontradas!</div>`;
                    
                    if (transactions.length > 0) {
                        html += '<div class="test-result">';
                        transactions.forEach((tx, index) => {
                            html += `
${index + 1}. ID: ${tx.id}
   Status: ${tx.status}
   Valor: R$ ${tx.amount.toFixed(2)}
   Criado: ${tx.created_at}
   ${tx.paid_at ? `Pago: ${tx.paid_at}` : ''}

`;
                        });
                        html += '</div>';
                    }
                    
                    resultDiv.innerHTML = html;
                    log(`‚úÖ ${transactions.length} transa√ß√µes listadas`);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erro ao listar transa√ß√µes: ${result.error}</div>`;
                    log(`‚ùå Erro ao listar transa√ß√µes: ${result.error}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro inesperado: ${error.message}</div>`;
                log(`‚ùå Erro inesperado ao listar transa√ß√µes: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Listar Transa√ß√µes';
            }
        }

        async function testFullDonation() {
            const button = event.target;
            const resultDiv = document.getElementById('donationResult');
            const baseAmount = parseFloat(document.getElementById('donationAmount').value);
            
            // Coletar add-ons selecionados
            const selectedAddons = [];
            if (document.getElementById('addonTransport').checked) {
                selectedAddons.push({ value: 10, name: 'Aux√≠lio Transporte', id: 'transport' });
            }
            if (document.getElementById('addonMeal').checked) {
                selectedAddons.push({ value: 15, name: 'Aux√≠lio Refei√ß√£o', id: 'meal' });
            }
            if (document.getElementById('addonBasket').checked) {
                selectedAddons.push({ value: 85, name: 'Cesta B√°sica', id: 'basket' });
            }
            
            const totalAmount = baseAmount + selectedAddons.reduce((sum, addon) => sum + addon.value, 0);
            
            button.disabled = true;
            button.textContent = 'Processando...';
            resultDiv.innerHTML = '<div class="info">üîÑ Processando doa√ß√£o completa...</div>';
            
            try {
                log(`üéØ Processando doa√ß√£o completa - Base: R$ ${baseAmount.toFixed(2)}, Add-ons: ${selectedAddons.length}, Total: R$ ${totalAmount.toFixed(2)}`);
                
                const result = await campaignPayments.processDonation(baseAmount, selectedAddons, {
                    name: 'Doador Teste',
                    email: 'doador@teste.com'
                });
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Doa√ß√£o processada com sucesso!</div>
                        <div class="test-result">
ID da Transa√ß√£o: ${result.transactionId}
Valor Base: R$ ${baseAmount.toFixed(2)}
Add-ons: ${selectedAddons.map(a => a.name).join(', ')}
Valor Total: R$ ${result.amount.toFixed(2)}
Status: ${result.status}
PIX Code: ${result.pixCode ? 'Gerado' : 'N√£o dispon√≠vel'}
QR Code: ${result.qrCodeBase64 ? 'Dispon√≠vel' : 'N√£o dispon√≠vel'}

üîó PIX Code (primeiros 100 caracteres):
${result.pixCode ? result.pixCode.substring(0, 100) + '...' : 'N/A'}
                        </div>
                    `;
                    log(`‚úÖ Doa√ß√£o processada com sucesso: ${result.transactionId}`);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erro ao processar doa√ß√£o: ${result.error}</div>`;
                    log(`‚ùå Erro ao processar doa√ß√£o: ${result.error}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro inesperado: ${error.message}</div>`;
                log(`‚ùå Erro inesperado ao processar doa√ß√£o: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = 'Processar Doa√ß√£o';
            }
        }
    </script>
</body>
</html>
