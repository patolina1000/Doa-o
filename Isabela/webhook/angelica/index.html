<!DOCTYPE html>
<html>
    <head>
        <title>Webhook RushPay - Ang√©lica</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .webhook-data {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .event-log {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .event-item {
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .event-item:last-child {
            border-bottom: none;
        }
        .timestamp {
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Webhook RushPay - Campanha Ang√©lica</h1>
        <p>Este endpoint recebe notifica√ß√µes da RushPay para a campanha da Ang√©lica.</p>
        
        <div class="status info">
            <h3>üìã Status do Webhook</h3>
            <p><strong>URL:</strong> <span id="webhookUrl">Carregando...</span></p>
            <p><strong>Status:</strong> <span id="webhookStatus">Aguardando notifica√ß√µes...</span></p>
            <p><strong>√öltima notifica√ß√£o:</strong> <span id="lastNotification">Nenhuma</span></p>
        </div>

        <div class="status info">
            <h3>üì• √öltima Notifica√ß√£o Recebida</h3>
            <div id="lastWebhookData" class="webhook-data">Nenhuma notifica√ß√£o recebida ainda...</div>
        </div>

        <div class="status info">
            <h3>üìù Hist√≥rico de Eventos</h3>
            <div id="eventHistory" class="event-log">Nenhum evento registrado...</div>
        </div>

        <div class="status warning">
            <h3>‚ö†Ô∏è Informa√ß√µes Importantes</h3>
            <ul>
                <li>Este webhook deve ser configurado na plataforma RushPay</li>
                <li>Eventos suportados: onPixCreated, onBuyApproved, onChargeback, onRefund</li>
                <li>As notifica√ß√µes s√£o processadas automaticamente</li>
                <li>Dados s√£o armazenados localmente para demonstra√ß√£o</li>
            </ul>
        </div>
    </div>

    <script>
        // Configura√ß√µes do webhook
        const WEBHOOK_CONFIG = {
            secretKey: '3a98c055-3db4-40a4-83be-f844653df074', // Secret Key para valida√ß√£o
            events: ['onPixCreated', 'onBuyApproved', 'onChargeback', 'onRefund'],
            maxHistory: 50 // M√°ximo de eventos no hist√≥rico
        };

        let eventHistory = [];
        let lastWebhookData = null;

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadWebhookInfo();
            loadEventHistory();
            logEvent('webhook_initialized', 'Webhook inicializado e pronto para receber notifica√ß√µes');
        });

        /**
         * Carrega informa√ß√µes do webhook
         */
        function loadWebhookInfo() {
            document.getElementById('webhookUrl').textContent = window.location.href;
            document.getElementById('webhookStatus').textContent = 'Ativo';
            document.getElementById('lastNotification').textContent = 'Nenhuma';
        }

        /**
         * Registra um evento no hist√≥rico
         */
        function logEvent(eventType, description, data = null) {
            const timestamp = new Date().toISOString();
            const event = {
                timestamp: timestamp,
                type: eventType,
                description: description,
                data: data
            };

            eventHistory.unshift(event);

            // Manter apenas os √∫ltimos eventos
            if (eventHistory.length > WEBHOOK_CONFIG.maxHistory) {
                eventHistory = eventHistory.slice(0, WEBHOOK_CONFIG.maxHistory);
            }

            // Salvar no localStorage
            localStorage.setItem('rushpay_webhook_history', JSON.stringify(eventHistory));

            // Atualizar interface
            updateEventHistory();
        }

        /**
         * Atualiza a interface do hist√≥rico de eventos
         */
        function updateEventHistory() {
            const container = document.getElementById('eventHistory');
            
            if (eventHistory.length === 0) {
                container.textContent = 'Nenhum evento registrado...';
                return;
            }

            let html = '';
            eventHistory.forEach(event => {
                const localTime = new Date(event.timestamp).toLocaleString('pt-BR');
                html += `
                    <div class="event-item">
                        <div class="timestamp">${localTime}</div>
                        <strong>${event.type}:</strong> ${event.description}
                        ${event.data ? `<br><small>Dados: ${JSON.stringify(event.data).substring(0, 100)}...</small>` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        /**
         * Carrega hist√≥rico de eventos do localStorage
         */
        function loadEventHistory() {
            const saved = localStorage.getItem('rushpay_webhook_history');
            if (saved) {
                try {
                    eventHistory = JSON.parse(saved);
                    updateEventHistory();
                } catch (error) {
                    console.error('Erro ao carregar hist√≥rico:', error);
                }
            }
        }

        /**
         * Valida assinatura do webhook conforme documenta√ß√£o
         */
        function validateWebhookSignature(payload, signature) {
            // Implementa√ß√£o b√°sica de valida√ß√£o
            // Em produ√ß√£o, usar HMAC-SHA256 conforme documenta√ß√£o
            try {
                const expectedSignature = btoa(JSON.stringify(payload) + WEBHOOK_CONFIG.secretKey);
                return signature === expectedSignature;
            } catch (error) {
                console.error('Erro na valida√ß√£o de assinatura:', error);
                return false;
            }
        }

        /**
         * Processa notifica√ß√£o do webhook conforme documenta√ß√£o
         */
        function processWebhookNotification(webhookData) {
            console.log('üîî Processando notifica√ß√£o do webhook:', webhookData);

            // Validar dados obrigat√≥rios conforme documenta√ß√£o
            const requiredFields = ['paymentId', 'status', 'paymentMethod', 'totalValue'];
            const missingFields = requiredFields.filter(field => !webhookData[field]);

            if (missingFields.length > 0) {
                logEvent('webhook_error', `Campos obrigat√≥rios ausentes: ${missingFields.join(', ')}`, webhookData);
                return false;
            }

            // Processar baseado no status
            switch (webhookData.status) {
                case 'APPROVED':
                    logEvent('payment_approved', `Pagamento aprovado - ID: ${webhookData.paymentId}`, webhookData);
                    handlePaymentApproved(webhookData);
                    break;
                case 'PENDING':
                    logEvent('payment_pending', `Pagamento pendente - ID: ${webhookData.paymentId}`, webhookData);
                    break;
                case 'REJECTED':
                    logEvent('payment_rejected', `Pagamento rejeitado - ID: ${webhookData.paymentId}`, webhookData);
                    break;
                case 'REFUNDED':
                    logEvent('payment_refunded', `Pagamento reembolsado - ID: ${webhookData.paymentId}`, webhookData);
                    break;
                case 'CHARGEBACK':
                    logEvent('payment_chargeback', `Chargeback - ID: ${webhookData.paymentId}`, webhookData);
                    break;
                default:
                    logEvent('payment_unknown_status', `Status desconhecido: ${webhookData.status}`, webhookData);
            }

            // Atualizar √∫ltima notifica√ß√£o
            lastWebhookData = webhookData;
            updateLastWebhookData();
            updateLastNotificationTime();

            return true;
        }

        /**
         * Manipula pagamento aprovado
         */
        function handlePaymentApproved(webhookData) {
            // Aqui voc√™ pode implementar l√≥gica espec√≠fica para pagamentos aprovados
            // Por exemplo: enviar email de confirma√ß√£o, atualizar banco de dados, etc.
            
            console.log('‚úÖ Pagamento aprovado processado:', {
                paymentId: webhookData.paymentId,
                amount: webhookData.totalValue,
                customer: webhookData.customer?.name
            });

            // Exemplo: salvar dados do pagamento aprovado
            const approvedPayments = JSON.parse(localStorage.getItem('rushpay_approved_payments') || '[]');
            approvedPayments.push({
                ...webhookData,
                processedAt: new Date().toISOString()
            });
            localStorage.setItem('rushpay_approved_payments', JSON.stringify(approvedPayments));
        }

        /**
         * Atualiza dados da √∫ltima notifica√ß√£o
         */
        function updateLastWebhookData() {
            const container = document.getElementById('lastWebhookData');
            if (lastWebhookData) {
                container.textContent = JSON.stringify(lastWebhookData, null, 2);
            } else {
                container.textContent = 'Nenhuma notifica√ß√£o recebida ainda...';
            }
        }

        /**
         * Atualiza timestamp da √∫ltima notifica√ß√£o
         */
        function updateLastNotificationTime() {
            const now = new Date().toLocaleString('pt-BR');
            document.getElementById('lastNotification').textContent = now;
        }

        /**
         * Simula recebimento de webhook para demonstra√ß√£o
         */
        function simulateWebhookNotification(eventType = 'onBuyApproved') {
            const mockWebhookData = {
                paymentId: `txn_${Date.now()}`,
                externalId: null,
                checkoutUrl: null,
                referrerUrl: null,
                customId: `demo_${Date.now()}`,
                status: 'APPROVED',
                paymentMethod: 'PIX',
                deliveryStatus: null,
                totalValue: 5000, // R$ 50,00 em centavos
                netValue: 4850,
                pixQrCode: null,
                pixCode: '00020126820014br.gov.bcb.pix2563pix.example.com/qr/v1/demo',
                billetUrl: null,
                billetCode: null,
                expiresAt: new Date(Date.now() + 3600000).toISOString(), // 1 hora
                dueAt: null,
                installments: null,
                utm: null,
                items: [
                    {
                        unitPrice: 5000,
                        title: 'Doa√ß√£o para campanha Ang√©lica',
                        quantity: 1
                    }
                ],
                customer: {
                    id: `cust_${Date.now()}`,
                    name: 'Jo√£o Silva',
                    email: 'joao@exemplo.com',
                    cpf: '12345678901',
                    cep: '01234-567',
                    phone: '+5511999999999',
                    complement: null,
                    number: '123',
                    street: 'Rua Exemplo',
                    city: 'S√£o Paulo',
                    state: 'SP',
                    district: 'Centro',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                },
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                approvedAt: new Date().toISOString(),
                refundedAt: null,
                chargebackAt: null,
                rejectedAt: null
            };

            processWebhookNotification(mockWebhookData);
        }

        // Expor fun√ß√µes para teste
        window.simulateWebhookNotification = simulateWebhookNotification;
        window.processWebhookNotification = processWebhookNotification;

        // Log de inicializa√ß√£o
        console.log('üîî Webhook RushPay inicializado e pronto para receber notifica√ß√µes');
        console.log('üìã Para testar, execute: simulateWebhookNotification() no console');
    </script>
</body>
</html>
