<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Handler - Ang√©lica</title>
</head>
<body>
    <h1>Webhook Handler</h1>
    <p>Status: <span id="status">Aguardando...</span></p>
    <div id="logs"></div>

    <script>
        // Handler de webhook para Vercel
        async function handleWebhook(request) {
            try {
                const data = await request.json();
                console.log('üì® Webhook recebido:', data);
                
                // Log do webhook
                document.getElementById('status').textContent = 'Webhook recebido!';
                document.getElementById('logs').innerHTML = `
                    <h3>Dados do Webhook:</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                // Processar diferentes tipos de evento
                switch(data.event) {
                    case 'onPixCreated':
                        console.log('‚úÖ PIX criado:', data.transactionId);
                        break;
                    case 'onBuyApproved':
                        console.log('‚úÖ Pagamento aprovado:', data.transactionId);
                        
                        // üî• NOVO: Disparar eventos do Facebook quando pagamento for aprovado
                        await sendFacebookEvents(data);
                        break;
                    case 'onChargeback':
                        console.log('‚ö†Ô∏è Chargeback:', data.transactionId);
                        break;
                    case 'onRefund':
                        console.log('üîÑ Reembolso:', data.transactionId);
                        break;
                    default:
                        console.log('üìù Evento desconhecido:', data.event);
                }
                
                return new Response(JSON.stringify({ success: true }), {
                    status: 200,
                    headers: { 'Content-Type': 'application/json' }
                });
                
            } catch (error) {
                console.error('‚ùå Erro no webhook:', error);
                return new Response(JSON.stringify({ error: error.message }), {
                    status: 500,
                    headers: { 'Content-Type': 'application/json' }
                });
            }
        }

        // üî• NOVA FUN√á√ÉO: Enviar eventos para Facebook CAPI
        async function sendFacebookEvents(webhookData) {
            try {
                console.log('üéØ Enviando eventos para Facebook CAPI...', webhookData);
                
                const accessToken = 'EAARGi7UlLlYBPRnu2QY9Sy1KMvImxGLjTwrVNnGzS2OOELuzMicB3e7m1PQZAFTxj4ZAsZAmzrK516jTC9JoZCfNBKsFwuOTlGVt26s906JZBInZAI3uHpSOOyRbDrtv73S7DXyluOZCsagruKgEfLq5SBQ1C4y4eA4gqYvvbThtfA0ALww2cbYs4pz7wfubwZDZD';
                const pixelId = '1513482096307953';
                
                const capiData = {
                    data: [{
                        event_name: 'Purchase',
                        event_time: Math.floor(Date.now() / 1000),
                        action_source: 'website',
                        event_source_url: 'https://angelica-angelica.vercel.app',
                        user_data: {
                            client_ip_address: webhookData.customer?.ip || '127.0.0.1',
                            client_user_agent: webhookData.customer?.userAgent || 'Webhook'
                        },
                        custom_data: {
                            currency: 'BRL',
                            value: webhookData.amount || 0,
                            transaction_id: webhookData.transactionId,
                            content_name: 'Doa√ß√£o Ang√©lica',
                            content_category: 'Health/Medical/Donation',
                            content_ids: ['donation_completed_angelica']
                        }
                    }, {
                        event_name: 'Donate',
                        event_time: Math.floor(Date.now() / 1000),
                        action_source: 'website',
                        event_source_url: 'https://angelica-angelica.vercel.app',
                        user_data: {
                            client_ip_address: webhookData.customer?.ip || '127.0.0.1',
                            client_user_agent: webhookData.customer?.userAgent || 'Webhook'
                        },
                        custom_data: {
                            currency: 'BRL',
                            value: webhookData.amount || 0,
                            content_name: 'Campanha Doa√ß√£o Ang√©lica',
                            content_category: 'Health/Medical/Donation'
                        }
                    }],
                    access_token: accessToken
                };
                
                const response = await fetch(`https://graph.facebook.com/v18.0/${pixelId}/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(capiData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Eventos Facebook enviados com sucesso via CAPI:', result);
                    
                    // Atualizar logs
                    document.getElementById('logs').innerHTML += `
                        <h3>‚úÖ Eventos Facebook Enviados:</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    const error = await response.text();
                    console.error('‚ùå Erro ao enviar eventos Facebook:', error);
                    
                    // Atualizar logs
                    document.getElementById('logs').innerHTML += `
                        <h3>‚ùå Erro Facebook CAPI:</h3>
                        <pre>${error}</pre>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Erro ao enviar eventos Facebook:', error);
                
                // Atualizar logs
                document.getElementById('logs').innerHTML += `
                    <h3>‚ùå Erro Facebook CAPI:</h3>
                    <pre>${error.message}</pre>
                `;
            }
        }

        // Para Vercel Functions (serverless)
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = handleWebhook;
        }

        // Para uso no navegador
        window.handleWebhook = handleWebhook;
    </script>
</body>
</html>
